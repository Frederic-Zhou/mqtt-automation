name: conditional_flow_test
description: "条件执行和步骤跳转测试脚本"
version: "1.0"

variables:
  target_text: "设置"
  min_x_coordinate: 400
  max_retry_count: 3
  current_retry: 0

steps:
  - name: initial_screenshot
    type: screenshot
    description: "获取初始截图"
    timeout: 10

  - name: find_primary_target
    type: check_text
    text: "{{target_text}}"
    description: "查找主要目标文本"
    timeout: 10
    output_vars:
      found_primary: "result"
      primary_x: "text_info[text='{{target_text}}'].x"
      primary_y: "text_info[text='{{target_text}}'].y"
      primary_count: "text_info.length"
    on_success: "validate_coordinates"
    on_failure: "find_alternative"

  - name: validate_coordinates
    type: check_text
    text: "{{target_text}}"
    description: "验证坐标是否在有效范围内"
    timeout: 5
    condition: "primary_x >= {{min_x_coordinate}}"
    on_success: "click_primary_target"
    on_failure: "find_alternative"

  - name: click_primary_target
    type: tap
    x: "{{primary_x}}"
    y: "{{primary_y}}"
    description: "点击主要目标"
    timeout: 5
    on_success: "verify_click"
    on_failure: "retry_click"

  - name: verify_click
    type: screenshot
    description: "验证点击效果"
    timeout: 10
    on_success: "end"

  - name: find_alternative
    type: check_text
    text: "浏览器"
    description: "查找替代目标"
    timeout: 10
    output_vars:
      found_alt: "result"
      alt_x: "text_info[text='浏览器'].x"
      alt_y: "text_info[text='浏览器'].y"
    condition: "current_retry < {{max_retry_count}}"
    on_success: "click_alternative"
    on_failure: "report_failure"

  - name: click_alternative
    type: tap
    x: "{{alt_x}}"
    y: "{{alt_y}}"
    description: "点击替代目标"
    timeout: 5
    on_success: "verify_alt_click"
    on_failure: "increment_retry"

  - name: verify_alt_click
    type: screenshot
    description: "验证替代点击效果"
    timeout: 10
    on_success: "end"

  - name: increment_retry
    type: wait
    timeout: 2
    description: "增加重试计数器"
    output_vars:
      current_retry: "{{current_retry}} + 1"
    on_success: "find_primary_target"

  - name: retry_click
    type: wait
    timeout: 1
    description: "短暂等待后重试"
    on_success: "click_primary_target"

  - name: report_failure
    type: screenshot
    description: "报告失败状态"
    timeout: 10

  - name: final_wait
    type: wait
    timeout: 3
    description: "最终等待"
